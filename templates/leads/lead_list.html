{% extends 'base.html' %}
{% load static %}

{% block title %}Leads{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-blue: #3b82f6;
        --secondary-purple: #764ba2;
        --dark-text: #333333;
        --input-border: #e1e8ed;
        --focus-shadow: rgba(59, 130, 246, 0.25);
        --link-normal: #3b82f6;
        --link-hover: #764ba2;
        --alert-danger-bg: #ffeeee;
        --alert-danger-text: #cc3333;
        --alert-success-bg: #eeffee;
        --alert-success-text: #33cc33;
    }

    /* Page Header */
    .page-header {
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-purple) 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .page-header h1 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 600;
    }

    .page-header .stats {
        display: flex;
        gap: 2rem;
        margin-top: 1rem;
        font-size: 0.95rem;
    }

    .page-header .stats .stat-item {
        opacity: 0.95;
    }

    /* Filter Section */
    .filter-section {
        background: white;
        border: 1px solid var(--input-border);
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .filter-section h5 {
        color: var(--dark-text);
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Search Box */
    .search-box input {
        border: 2px solid var(--input-border);
        border-radius: 8px;
        padding: 0.6rem 1rem;
        transition: all 0.3s;
    }

    .search-box input:focus {
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 0.2rem var(--focus-shadow);
    }

    /* Filter Dropdowns */
    .form-select {
        border: 2px solid var(--input-border);
        border-radius: 8px;
        transition: all 0.3s;
    }

    .form-select:focus {
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 0.2rem var(--focus-shadow);
    }

    /* Table Styling */
    .leads-table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .leads-table table {
        margin-bottom: 0;
    }

    .leads-table thead {
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-purple) 100%);
        color: white;
    }

    .leads-table thead th {
        border: none;
        font-weight: 600;
        padding: 1rem;
        font-size: 0.9rem;
    }

    .leads-table tbody tr {
        border-bottom: 1px solid var(--input-border);
        transition: background-color 0.2s;
    }

    .leads-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .leads-table tbody td {
        padding: 0.9rem 1rem;
        vertical-align: middle;
        color: var(--dark-text);
    }

    /* Badges */
    .badge-source {
        padding: 0.35rem 0.65rem;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .badge-status-new {
        background-color: #17a2b8;
        color: white;
    }

    .badge-status-contacted {
        background-color: #ffc107;
        color: var(--dark-text);
    }

    .badge-status-qualified {
        background-color: #28a745;
        color: white;
    }

    .badge-status-converted {
        background-color: var(--primary-blue);
        color: white;
    }

    .badge-priority-low {
        background-color: #6c757d;
        color: white;
    }

    .badge-priority-medium {
        background-color: #ffc107;
        color: var(--dark-text);
    }

    .badge-priority-high {
        background-color: #dc3545;
        color: white;
    }

    /* Action Buttons */
    .btn-view {
        background-color: var(--primary-blue);
        border: none;
        color: white;
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-size: 0.85rem;
        transition: all 0.3s;
    }

    .btn-view:hover {
        background-color: var(--secondary-purple);
        color: white;
        transform: translateY(-1px);
    }

    /* Bulk Actions */
    .bulk-actions {
        background: white;
        border: 1px solid var(--input-border);
        border-radius: 8px;
        padding: 0.8rem 1rem;
        margin-bottom: 1rem;
        display: none;
    }

    .bulk-actions.active {
        display: block;
    }

    .bulk-actions .btn {
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
    }

    /* Pagination */
    .pagination {
        margin-top: 1.5rem;
    }

    .pagination .page-link {
        color: var(--link-normal);
        border: 1px solid var(--input-border);
        padding: 0.5rem 0.75rem;
    }

    .pagination .page-link:hover {
        background-color: var(--primary-blue);
        border-color: var(--primary-blue);
        color: white;
    }

    .pagination .page-item.active .page-link {
        background-color: var(--primary-blue);
        border-color: var(--primary-blue);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }

    .empty-state h4 {
        color: var(--dark-text);
        margin-bottom: 0.5rem;
    }

    /* Checkbox Styling */
    .form-check-input:checked {
        background-color: var(--primary-blue);
        border-color: var(--primary-blue);
    }

    .form-check-input:focus {
        box-shadow: 0 0 0 0.2rem var(--focus-shadow);
    }

    /* New Lead Button */
    .btn-new-lead {
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-purple) 100%);
        border: none;
        color: white;
        padding: 0.6rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        transition: all 0.3s;
    }

    .btn-new-lead:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        color: white;
    }

    /* View Toggle Buttons */
    .view-toggle {
        display: flex;
        gap: 0.5rem;
    }

    .view-toggle .btn {
        padding: 0.5rem 1rem;
        border: 2px solid var(--input-border);
        background: white;
        color: var(--dark-text);
        transition: all 0.3s;
    }

    .view-toggle .btn.active {
        background: var(--primary-blue);
        border-color: var(--primary-blue);
        color: white;
    }

    .view-toggle .btn:hover {
        border-color: var(--primary-blue);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1><i class="fas fa-users me-2"></i>Leads</h1>
                <div class="stats">
                    <div class="stat-item">
                        <i class="fas fa-list me-1"></i>
                        <strong>{{ total_count }}</strong> Total
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-plus-circle me-1"></i>
                        <strong>{{ status_counts.new }}</strong> New
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-phone me-1"></i>
                        <strong>{{ status_counts.contacted }}</strong> Contacted
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-check-circle me-1"></i>
                        <strong>{{ status_counts.qualified }}</strong> Qualified
                    </div>
                </div>
            </div>
            <div class="d-flex gap-2">
                <!-- View Toggle -->
                <div class="view-toggle">
                    <a href="{% url 'leads:lead_list' %}" class="btn active">
                        <i class="fas fa-list"></i>
                    </a>
                    <a href="{% url 'leads:lead_kanban' %}" class="btn">
                        <i class="fas fa-th"></i>
                    </a>
                </div>

                <!-- New Lead Button -->
                <a href="{% url 'leads:lead_create' %}" class="btn btn-new-lead">
                    <i class="fas fa-plus me-2"></i>New Lead
                </a>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filter-section">
        <h5><i class="fas fa-filter me-2"></i>Filters & Search</h5>

        <form method="GET" id="filterForm">
            <div class="row g-3">
                <!-- Search -->
                <div class="col-md-3">
                    <div class="search-box">
                        <input type="text" name="search" class="form-control" placeholder="Search name, phone, email..."
                            value="{{ search_query }}">
                    </div>
                </div>

                <!-- Source Filter -->
                <div class="col-md-2">
                    {{ filter_form.source }}
                </div>

                <!-- Stage Filter -->
                <div class="col-md-2">
                    {{ filter_form.stage }}
                </div>

                <!-- Status Filter -->
                <div class="col-md-2">
                    {{ filter_form.status }}
                </div>

                <!-- Priority Filter -->
                <div class="col-md-2">
                    {{ filter_form.priority }}
                </div>

                <!-- Search Button -->
                <div class="col-md-1">
                    <button type="submit" class="btn btn-view w-100">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            <!-- Advanced Filters (Collapsible) -->
            <div class="collapse mt-3" id="advancedFilters">
                <div class="row g-3">
                    <div class="col-md-3">
                        {{ filter_form.assigned_to }}
                    </div>
                    <div class="col-md-3">
                        {{ filter_form.date_from }}
                    </div>
                    <div class="col-md-3">
                        {{ filter_form.date_to }}
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                            <i class="fas fa-redo me-2"></i>Reset
                        </button>
                    </div>
                </div>
            </div>

            <!-- Toggle Advanced Filters -->
            <div class="mt-2">
                <a class="btn btn-link" data-bs-toggle="collapse" href="#advancedFilters"
                    style="color: var(--link-normal); text-decoration: none;">
                    <i class="fas fa-chevron-down me-1"></i>Advanced Filters
                </a>
            </div>
        </form>
    </div>

    <!-- Bulk Actions Bar -->
    <div class="bulk-actions" id="bulkActionsBar">
        <div class="d-flex justify-content-between align-items-center">
            <span><strong id="selectedCount">0</strong> leads selected</span>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" onclick="bulkAssign()">
                    <i class="fas fa-user-plus me-1"></i>Assign
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="bulkChangeStatus()">
                    <i class="fas fa-exchange-alt me-1"></i>Change Status
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="bulkDelete()">
                    <i class="fas fa-trash me-1"></i>Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Leads Table -->
    <div class="leads-table">
        {% if leads %}
        <table class="table table-hover">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" class="form-check-input" id="selectAll">
                    </th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Source</th>
                    <th>Stage</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Assigned To</th>
                    <th>Created</th>
                    <th style="width: 100px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for lead in leads %}
                <tr>
                    <td>
                        <input type="checkbox" class="form-check-input lead-checkbox" data-lead-id="{{ lead.id }}">
                    </td>
                    <td>
                        <strong>{{ lead.name }}</strong>
                        {% if lead.email %}
                        <br><small class="text-muted">{{ lead.email }}</small>
                        {% endif %}
                    </td>
                    <td>
                        <i class="fas fa-phone text-success me-1"></i>
                        {{ lead.phone }}
                    </td>
                    <td>
                        <span class="badge-source" style="background-color: {{ lead.source.color }}; color: white;">
                            <i class="{{ lead.source.icon }} me-1"></i>{{ lead.source.name }}
                        </span>
                    </td>
                    <td>
                        <span class="badge-source" style="background-color: {{ lead.stage.color }}; color: white;">
                            <i class="{{ lead.stage.icon }} me-1"></i>{{ lead.stage.name }}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-status-{{ lead.status }}">
                            {{ lead.get_status_display }}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-priority-{{ lead.priority }}">
                            {{ lead.get_priority_display }}
                        </span>
                    </td>
                    <td>
                        {% if lead.assigned_to %}
                        <span
                            style="background-color: var(--primary-blue); color: white; padding: 2px 6px; border-radius: 50%; font-size: 0.75rem;">
                            {{ lead.assigned_to.get_initials }}
                        </span>
                        {{ lead.assigned_to.get_full_name }}
                        {% else %}
                        <span class="text-muted">Unassigned</span>
                        {% endif %}
                    </td>
                    <td>
                        <small class="text-muted">{{ lead.time_since_created }}</small>
                    </td>
                    <td>
                        <a href="{% url 'leads:lead_detail' pk=lead.pk %}" class="btn btn-view btn-sm">
                            <i class="fas fa-eye"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Pagination -->
        {% if is_paginated %}
        <div class="p-3">
            <nav>
                <ul class="pagination justify-content-center mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for num in page_range %}
                    <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                        <a class="page-link"
                            href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}">
                            {{ num }}
                        </a>
                    </li>
                    {% endfor %}

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                            <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}

        {% else %}
        <!-- Empty State -->
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h4>No Leads Found</h4>
            <p>No leads match your current filters, or you haven't created any leads yet.</p>
            <a href="{% url 'leads:lead_create' %}" class="btn btn-new-lead mt-3">
                <i class="fas fa-plus me-2"></i>Create Your First Lead
            </a>
        </div>
        {% endif %}
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    // Select All Checkbox
    document.getElementById('selectAll').addEventListener('change', function () {
        const checkboxes = document.querySelectorAll('.lead-checkbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateBulkActions();
    });

    // Individual Checkboxes
    document.querySelectorAll('.lead-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActions);
    });

    // Update Bulk Actions Bar
    function updateBulkActions() {
        const selected = document.querySelectorAll('.lead-checkbox:checked');
        const bulkBar = document.getElementById('bulkActionsBar');
        const countSpan = document.getElementById('selectedCount');

        countSpan.textContent = selected.length;

        if (selected.length > 0) {
            bulkBar.classList.add('active');
        } else {
            bulkBar.classList.remove('active');
        }
    }

    // Reset Filters
    function resetFilters() {
        window.location.href = '{% url "leads:lead_list" %}';
    }

    // Bulk Actions
    function bulkAssign() {
        const selected = getSelectedLeads();
        if (selected.length === 0) return;

        // Show assign modal (to be implemented)
        alert(`Assigning ${selected.length} leads...`);
    }

    function bulkChangeStatus() {
        const selected = getSelectedLeads();
        if (selected.length === 0) return;

        // Show status change modal (to be implemented)
        alert(`Changing status for ${selected.length} leads...`);
    }

    function bulkDelete() {
        const selected = getSelectedLeads();
        if (selected.length === 0) return;

        if (confirm(`Are you sure you want to delete ${selected.length} leads?`)) {
            // Submit bulk delete (to be implemented)
            alert('Deleting leads...');
        }
    }

    function getSelectedLeads() {
        const checkboxes = document.querySelectorAll('.lead-checkbox:checked');
        return Array.from(checkboxes).map(cb => cb.dataset.leadId);
    }

    // Auto-submit on filter change
    document.querySelectorAll('#filterForm select').forEach(select => {
        select.addEventListener('change', function () {
            document.getElementById('filterForm').submit();
        });
    });
</script>
{% endblock %}